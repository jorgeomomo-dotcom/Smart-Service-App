 
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ V20.0 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµÙØ§Ø©</title>
    <style>
        :root { --primary: #0D47A1; --bg: #ECEFF1; --surface: #FFFFFF; --success: #2E7D32; --danger: #C62828; --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; direction: rtl; }
        header { background: var(--surface); padding: 12px 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .calendar-container { overflow-x: auto; margin: 10px; background: var(--surface); border-radius: var(--radius); border: 1px solid #CFD8DC; }
        .calendar-grid { display: grid; min-width: max-content; }
        .calendar-grid div { padding: 8px; border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; min-height: 50px; text-align: center; }
        .employee-name-cell { position: sticky; right: 0; background: #F8F9FA; font-weight: bold; z-index: 2; width: 140px; border-left: 3px solid var(--primary); }
        .attendance-cell { cursor: pointer; font-size: 0.85rem; min-width: 60px; position: relative; }
        .status-present { background: #E8F5E9; color: var(--success); }
        .status-absent { background: #FFEBEE; color: var(--danger); font-weight: bold; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 20px; border-radius: var(--radius); width: 100%; max-width: 400px; }
        button { cursor: pointer; border: none; font-weight: bold; padding: 12px; border-radius: 8px; width: 100%; margin: 5px 0; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
        .row-now { display: flex; gap: 5px; align-items: center; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--primary); margin: 0 4px; }
        .pin-dot.active { background: var(--primary); }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; direction: ltr; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; justify-content:space-between; align-items:center">
        <b style="color:var(--primary)">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ V20.0</b>
        <span id="lockStatus" style="font-size:0.8rem; color:red">ğŸ”’ Ù…Ø­Ù…ÙŠ</span>
    </div>
</header>

<div id="contentArea" style="display:none">
    <div style="display:flex; justify-content:space-between; padding:10px; align-items:center">
        <button onclick="changeMonth(-1)" style="width:40px; background:#ddd">â—€</button>
        <b id="monthLabel"></b>
        <button onclick="changeMonth(1)" style="width:40px; background:#ddd">â–¶</button>
    </div>
    
    <div class="calendar-container"><div id="calendarGrid" class="calendar-grid"></div></div>
    
    <div style="padding:15px; background: #fff; margin: 10px; border-radius: 12px;">
        <select id="empSelect" style="width:100%; padding:10px; margin-bottom:10px;"></select>
        <button onclick="sendSelectedReport()" style="background:#00796B; color:white">Ø§Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø¢Ø¨</button>
    </div>

    <div style="padding:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn-main" onclick="openAdvances()">ğŸ’° Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</button>
        <button class="btn-main" onclick="printReport()" style="background:var(--success)">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        <button class="btn-main" onclick="openSettings()" style="background:#546E7A;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="btn-main" onclick="clearAttendanceOnly()" style="background:var(--danger);">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªØ£Ø´ÙŠØ±</button>
    </div>
</div>

<div id="pinModal" class="modal" style="display:flex">
    <div class="modal-content" align="center">
        <div id="lockWarning" style="color:red; font-weight:bold; display:none;">âš ï¸ Ø§Ù„Ù…Ø§Ø³ØªØ± ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨ (8 Ø£Ø±Ù‚Ø§Ù…)</div>
        <h3 id="pinTitle">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <div style="display:flex; justify-content:center; margin:20px 0" id="dotsContainer"></div>
        <div class="pin-grid" id="keypad"></div>
        <button onclick="location.reload()" style="background:#eee; margin-top:10px">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="attModal" class="modal">
    <div class="modal-content">
        <h3 id="attEmpName" align="center"></h3>
        <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; border:1px dashed #ccc">
            <label style="font-size:0.8rem;">Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</label>
            <div class="row-now"><input type="number" id="currentRateInput"><button onclick="updateRate()" style="background:var(--primary); color:white; padding:5px; font-size:11px;">ØªØ­Ø¯ÙŠØ«</button></div>
        </div>
        <label>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±:</label>
        <input type="time" id="tIn">
        <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù:</label>
        <input type="time" id="tOut">
        <button class="btn-main" onclick="processAtt('save')" id="saveBtn">Ø­ÙØ¸</button>
        <button class="btn-main" style="background:var(--danger)" onclick="processAtt('absent')">ØºÙŠØ§Ø¨</button>
        <button class="btn-main" style="background:#666; display:none;" id="delBtn" onclick="processAtt('delete')">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</button>
        <button onclick="closeM('attModal')" style="background:#eee">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="settingsModal" class="modal"><div class="modal-content"><h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3><div id="eList" style="max-height:150px; overflow-y:auto;"></div><input id="newE" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„"><input id="newR" type="number" placeholder="Ø§Ù„Ø£Ø¬Ø±"><button class="btn-main" onclick="addE()">+ Ø¥Ø¶Ø§ÙØ©</button><hr><input type="password" id="p1" placeholder="Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯" maxlength="4"><button onclick="updatePin()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø²</button><button onclick="closeM('settingsModal')" style="background:#eee">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
<div id="advancesModal" class="modal"><div class="modal-content"><h3>ğŸ’° Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</h3><div id="advListArea" style="max-height: 300px; overflow-y: auto;"></div><button onclick="closeM('advancesModal')" style="background:#eee">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

<script>
    let appData = { emps: [], att: {}, pin: "0000", advances: {} };
    const MASTER = "10031945";
    let pinIn = "", currDate = new Date(), sel = null, fails = 0, locked = false;

    window.onload = () => {
        const saved = localStorage.getItem('salary_final_v20');
        if(saved) appData = JSON.parse(saved);
        setupKeypad();
        render();
    };

    function setupKeypad() {
        const keypad = document.getElementById('keypad');
        keypad.innerHTML = [...Array(9).keys()].map(i => `<button onclick="pressPin('${i+1}')">${i+1}</button>`).join('') + 
        `<button onclick="clearPin()" style="background:#ffcdd2">C</button><button onclick="pressPin('0')">0</button><button onclick="backspacePin()">ğŸ”™</button>`;
        setupDots(4);
    }

    function setupDots(n) { document.getElementById('dotsContainer').innerHTML = '<div class="pin-dot"></div>'.repeat(n); }

    function pressPin(n) {
        let max = locked ? 8 : 4;
        if(pinIn.length < max) { pinIn += n; updateDots(); if(pinIn.length === max) checkPin(); }
    }

    function checkPin() {
        if(locked) {
            if(pinIn === MASTER) { locked = false; fails = 0; appData.pin = "0000"; save(); location.reload(); }
            else { alert("Ø®Ø·Ø£!"); clearPin(); }
        } else {
            if(pinIn === appData.pin) { document.getElementById('pinModal').style.display='none'; document.getElementById('contentArea').style.display='block'; }
            else { fails++; if(fails>=3) { locked=true; document.getElementById('lockWarning').style.display='block'; setupDots(8); } else alert("Ø®Ø·Ø£!"); clearPin(); }
        }
    }

    function updateDots() { document.querySelectorAll('.pin-dot').forEach((d, i) => d.className = i < pinIn.length ? 'pin-dot active' : 'pin-dot'); }
    function clearPin() { pinIn = ""; updateDots(); }
    function backspacePin() { pinIn = pinIn.slice(0,-1); updateDots(); }

    function getDiff(t1, t2) {
        let [h1, m1] = t1.split(':').map(Number), [h2, m2] = t2.split(':').map(Number);
        let mIn = h1*60+m1, mOut = h2*60+m2;
        return (mOut < mIn) ? (1440-mIn)+mOut : mOut-mIn;
    }

    function render() {
        const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        document.getElementById('monthLabel').innerText = months[currDate.getMonth()] + " " + currDate.getFullYear();
        const grid = document.getElementById('calendarGrid'), days = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        grid.style.gridTemplateColumns = `140px repeat(${days}, 60px)`;
        grid.innerHTML = '<div></div>' + [...Array(days).keys()].map(i => `<div><b>${i+1}</b></div>`).join('');
        
        document.getElementById('empSelect').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù…Ù„ --</option>' + appData.emps.map(e => `<option value="${e.id}">${e.name}</option>`).join('');

        appData.emps.forEach(e => {
            grid.innerHTML += `<div class="employee-name-cell">${e.name}</div>`;
            for(let d=1; d<=days; d++) {
                let key = `${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`, data = appData.att[key], txt = '-', cls = 'attendance-cell';
                if(data) {
                    if(data.mTotal) { cls += ' status-present'; txt = Math.floor(data.mTotal/60)+'Ø³'; }
                    else if(data.abs) { cls += ' status-absent'; txt = 'âœ•'; }
                }
                grid.innerHTML += `<div class="${cls}" onclick="openAtt('${e.id}',${d},'${key}')">${txt}</div>`;
            }
        });
    }

    function openAtt(empId, d, key) {
        sel = { e: appData.emps.find(x=>x.id==empId), d, key };
        let data = appData.att[key] || {};
        document.getElementById('attEmpName').innerText = sel.e.name;
        document.getElementById('currentRateInput').value = data.rate || sel.e.rate;
        document.getElementById('tIn').value = data.tIn || "08:00";
        document.getElementById('tOut').value = data.tOut || "06:00";
        document.getElementById('delBtn').style.display = data.tIn ? 'block' : 'none';
        document.getElementById('attModal').style.display = 'flex';
    }

    function processAtt(type) {
        if(type === 'save') {
            let tIn = document.getElementById('tIn').value, tOut = document.getElementById('tOut').value;
            appData.att[sel.key] = { tIn, tOut, mTotal: getDiff(tIn, tOut), rate: parseFloat(document.getElementById('currentRateInput').value) };
        } else if(type === 'absent') { appData.att[sel.key] = { abs: true }; }
        else if(type === 'delete') { delete appData.att[sel.key]; }
        save(); closeM('attModal');
    }

    function updateRate() { sel.e.rate = parseFloat(document.getElementById('currentRateInput').value); save(); alert("ØªÙ…!"); }
    function save() { localStorage.setItem('salary_final_v20', JSON.stringify(appData)); render(); }
    function closeM(id) { document.getElementById(id).style.display='none'; }
    function changeMonth(n) { currDate.setMonth(currDate.getMonth()+n); render(); }

    function sendSelectedReport() {
        let empId = document.getElementById('empSelect').value; if(!empId) return;
        let e = appData.emps.find(x=>x.id==empId), total=0, detail="", days = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        for(let d=1; d<=days; d++) {
            let r = appData.att[`${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`];
            if(r && r.mTotal) { let dayEarn = (r.mTotal/480)*r.rate; total+=dayEarn; }
        }
        let adv = (appData.advances[`${currDate.getFullYear()}-${currDate.getMonth()}`]?.[e.id] || []).reduce((s,i)=>s+i.val, 0);
        let msg = `ğŸ‘¤ ${e.name}\nğŸ’µ Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${Math.round(total)}Ø¯Ø¬\nğŸ“‰ ØªØ³Ø¨ÙŠÙ‚Ø§Øª: ${adv}Ø¯Ø¬\nğŸ’° Ø§Ù„ØµØ§ÙÙŠ: ${Math.round(total-adv)}Ø¯Ø¬`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    }

    function openSettings() {
        document.getElementById('eList').innerHTML = appData.emps.map(e => `<div>${e.name} <button onclick="delE('${e.id}')" style="width:auto; padding:2px; background:red;">X</button></div>`).join('');
        document.getElementById('settingsModal').style.display='flex';
    }
    function addE() { let n=document.getElementById('newE').value, r=document.getElementById('newR').value; if(n&&r){appData.emps.push({id:Date.now(), name:n, rate:parseFloat(r)}); save(); openSettings();} }
    function delE(id) { appData.emps=appData.emps.filter(e=>e.id!=id); save(); openSettings(); }
    function updatePin() { let p=document.getElementById('p1').value; if(p.length==4){appData.pin=p; save(); alert("ØªÙ…!");} }

    function openAdvances() {
        let mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; if(!appData.advances[mk]) appData.advances[mk]={};
        document.getElementById('advListArea').innerHTML = appData.emps.map(e => {
            let ads = appData.advances[mk][e.id] || [];
            return `<div><b>${e.name}</b> <input type="number" id="v_${e.id}" style="width:60px"> <button onclick="addAdv('${e.id}')" style="width:auto">+</button>
            ${ads.map(a=>`<div>${a.val}</div>`).join('')}</div>`;
        }).join('');
        document.getElementById('advancesModal').style.display='flex';
    }
    function addAdv(id) { let v=document.getElementById('v_'+id).value, mk=`${currDate.getFullYear()}-${currDate.getMonth()}`; if(v){ if(!appData.advances[mk][id]) appData.advances[mk][id]=[]; appData.advances[mk][id].push({val:parseFloat(v)}); save(); openAdvances(); } }
    function clearAttendanceOnly() { if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ")){appData.att={}; appData.advances={}; save(); location.reload();}}
</script>
</body>
</html>
