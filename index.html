 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام الرواتب - نسخة الهاتف</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; direction: rtl; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
        h2 { color: #0D47A1; text-align: center; }
        button { background: #0D47A1; color: white; border: none; padding: 12px; border-radius: 5px; width: 100%; font-size: 16px; font-weight: bold; margin-top: 5px; cursor: pointer; }
        .btn-success { background: #2E7D32; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 12px; }
        .present { background: #e8f5e9; }
    </style>
</head>
<body>

<div class="card">
    <h2>نظام الرواتب V14.0</h2>
    <div id="dateDisplay" style="text-align:center; font-weight:bold;"></div>
</div>

<div class="card" id="addEmpSection">
    <b>إضافة عامل جديد:</b>
    <input type="text" id="eName" placeholder="اسم العامل">
    <input type="number" id="eRate" placeholder="اليومية (دج)">
    <button onclick="addEmployee()">إضافة العامل</button>
</div>

<div class="card" style="overflow-x:auto;">
    <b>سجل الحضور اليومي:</b>
    <table id="mainTable">
        <thead><tr id="tableHead"><th>العامل</th></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="card">
    <button class="btn-success" onclick="exportReport()">إرسال كشف الراتب (واتساب)</button>
</div>

<script>
    // البيانات الافتراضية
    let data = JSON.parse(localStorage.getItem('salary_v14_final')) || { emps: [], att: {} };
    let today = new Date();
    document.getElementById('dateDisplay').innerText = today.toLocaleDateString('ar-EG', {month:'long', year:'numeric'});

    function addEmployee() {
        let name = document.getElementById('eName').value;
        let rate = document.getElementById('eRate').value;
        if(name && rate) {
            data.emps.push({ id: Date.now(), name, rate: parseFloat(rate) });
            save();
            render();
            document.getElementById('eName').value = "";
            document.getElementById('eRate').value = "";
        }
    }

    function markAtt(empId) {
        let tIn = prompt("وقت الدخول (مثلاً 08:00)", "08:00");
        let tOut = prompt("وقت الخروج (مثلاً 06:00)", "06:00");
        
        if(tIn && tOut) {
            let [h1, m1] = tIn.split(':').map(Number);
            let [h2, m2] = tOut.split(':').map(Number);
            let totalIn = h1 * 60 + m1;
            let totalOut = h2 * 60 + m2;

            // تصحيح مشكلة الـ 6 مساءً (نظام 12 ساعة)
            if (totalOut <= totalIn) totalOut += 720; 

            let diff = totalOut - totalIn;
            let key = `${today.getDate()}-${empId}`;
            data.att[key] = { tIn, tOut, mins: diff };
            save();
            render();
        }
    }

    function render() {
        const body = document.getElementById('tableBody');
        body.innerHTML = "";
        data.emps.forEach(emp => {
            let key = `${today.getDate()}-${emp.id}`;
            let record = data.att[key];
            let timeTxt = record ? `${Math.floor(record.mins/60)}س ${record.mins%60}د` : "لم يسجل";
            let row = `<tr class="${record ? 'present' : ''}">
                <td>${emp.name}</td>
                <td><button onclick="markAtt(${emp.id})">${timeTxt}</button></td>
            </tr>`;
            body.innerHTML += row;
        });
    }

    function exportReport() {
        let txt = "تقرير رواتب اليوم:\n";
        data.emps.forEach(e => {
            let key = `${today.getDate()}-${e.id}`;
            let r = data.att[key];
            if(r) {
                let salary = (r.mins / 480) * e.rate;
                txt += `${e.name}: ${Math.floor(r.mins/60)}س -> ${Math.round(salary)} دج\n`;
            }
        });
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
    }

    function save() { localStorage.setItem('salary_v14_final', JSON.stringify(data)); }
    
    // تشغيل البرنامج عند الفتح
    render();
</script>
</body>
</html>

